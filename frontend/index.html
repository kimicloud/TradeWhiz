<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeWhiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-chart-line text-3xl text-indigo-600"></i>
                    <h1 class="text-3xl font-bold text-gray-900">TradeWhiz</h1>
                </div>
                <div class="text-sm text-gray-500">
                    Moving Average Crossover Strategy
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Info Card -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="flex items-center space-x-3 mb-4">
                <i class="fas fa-info-circle text-indigo-600 text-xl"></i>
                <h2 class="text-xl font-semibold text-gray-900">How It Works</h2>
            </div>
            <p class="text-gray-600 leading-relaxed">
                This simulator tests a moving average crossover strategy. When the shorter MA crosses above the longer MA, 
                it generates a <span class="text-green-600 font-semibold">BUY</span> signal. When it crosses below, 
                it generates a <span class="text-red-600 font-semibold">SELL</span> signal. The strategy assumes you 
                buy/sell the entire position at each signal.
            </p>
        </div>

        <!-- Input Form -->
        <div class="bg-white rounded-xl shadow-md p-8">
            <form id="simulationForm" class="space-y-6">
                <!-- Stock Symbol -->
                <div>
                    <label for="symbol" class="flex items-center space-x-2 text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-building text-indigo-600"></i>
                        <span>Stock Symbol</span>
                    </label>
                    <input 
                        type="text" 
                        id="symbol" 
                        name="symbol" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                        placeholder="e.g., TCS.NS, AAPL, MSFT"
                        required
                    >
                    <p class="text-xs text-gray-500 mt-1">Use Yahoo Finance symbols (e.g., TCS.NS for Indian stocks)</p>
                </div>

                <!-- Date Inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="startDate" class="flex items-center space-x-2 text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt text-indigo-600"></i>
                            <span>Start Date</span>
                        </label>
                        <input 
                            type="date" 
                            id="startDate" 
                            name="startDate" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                            required
                        >
                    </div>
                    <div>
                        <label for="endDate" class="flex items-center space-x-2 text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt text-indigo-600"></i>
                            <span>End Date</span>
                        </label>
                        <input 
                            type="date" 
                            id="endDate" 
                            name="endDate" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                            required
                        >
                    </div>
                </div>

                <!-- Moving Average Inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="ma1" class="flex items-center space-x-2 text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-chart-line text-indigo-600"></i>
                            <span>Short MA (days)</span>
                        </label>
                        <input 
                            type="number" 
                            id="ma1" 
                            name="ma1" 
                            min="1" 
                            max="200"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                            placeholder="e.g., 10"
                            required
                        >
                    </div>
                    <div>
                        <label for="ma2" class="flex items-center space-x-2 text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-chart-line text-indigo-600"></i>
                            <span>Long MA (days)</span>
                        </label>
                        <input 
                            type="number" 
                            id="ma2" 
                            name="ma2" 
                            min="2" 
                            max="500"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                            placeholder="e.g., 50"
                            required
                        >
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-center pt-4">
                    <button 
                        type="submit" 
                        id="simulateBtn"
                        class="bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-semibold py-3 px-8 rounded-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                    >
                        <i class="fas fa-play mr-2"></i>
                        Run Simulation
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 flex items-center space-x-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <div class="text-lg font-medium text-gray-900">Running simulation...</div>
            </div>
        </div>

        <!-- Error Alert -->
        <div id="errorAlert" class="hidden mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                <div>
                    <h3 class="text-sm font-medium text-red-800">Simulation Error</h3>
                    <p id="errorMessage" class="text-sm text-red-700 mt-1"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center text-gray-500 text-sm">
                <p>Built with FastAPI, Tailwind CSS, and Plotly.js</p>
            </div>
        </div>
    </footer>

    <script>
        // DOM elements
        const form = document.getElementById('simulationForm');
        const submitBtn = document.getElementById('simulateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');

        // Backend URL configuration - FIXED FOR VERCEL
        function getBackendUrl() {
            // Always use your Render backend URL when deployed on Vercel
            return 'https://tradewhiz-backend.onrender.com';
        }

        // Set default dates
        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setFullYear(endDate.getFullYear() - 1); // 1 year ago
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        }

        // Set default values
        function setDefaults() {
            setDefaultDates();
            document.getElementById('symbol').value = 'TCS.NS';
            document.getElementById('ma1').value = '10';
            document.getElementById('ma2').value = '50';
        }

        // Validate form inputs
        function validateForm(formData) {
            const errors = [];
            
            // Check symbol
            if (!formData.symbol.trim()) {
                errors.push('Stock symbol is required');
            }
            
            // Check dates
            const startDate = new Date(formData.start_date);
            const endDate = new Date(formData.end_date);
            const today = new Date();
            
            if (startDate >= endDate) {
                errors.push('Start date must be before end date');
            }
            
            if (endDate > today) {
                errors.push('End date cannot be in the future');
            }
            
            // Check if date range is too short
            const daysDiff = (endDate - startDate) / (1000 * 60 * 60 * 24);
            if (daysDiff < 30) {
                errors.push('Date range should be at least 30 days');
            }
            
            // Check moving averages
            const ma1 = parseInt(formData.ma1_window);
            const ma2 = parseInt(formData.ma2_window);
            
            if (ma1 <= 0 || ma2 <= 0) {
                errors.push('Moving average windows must be positive numbers');
            }
            
            if (ma1 >= ma2) {
                errors.push('Short MA window must be smaller than Long MA window');
            }
            
            if (ma2 > daysDiff) {
                errors.push('Long MA window is too large for the selected date range');
            }
            
            return errors;
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
            setTimeout(() => {
                errorAlert.classList.add('hidden');
            }, 8000);
        }

        // Show loading state
        function showLoading() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running...';
            loadingIndicator.classList.remove('hidden');
            errorAlert.classList.add('hidden');
        }

        // Hide loading state
        function hideLoading() {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Run Simulation';
            loadingIndicator.classList.add('hidden');
        }

        // Test backend connection
        async function testBackendConnection() {
            const backendUrl = getBackendUrl();
            try {
                const response = await fetch(`${backendUrl}/test`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Backend connection successful:', data);
                    return true;
                } else {
                    console.warn('Backend connection failed:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Backend connection error:', error);
                return false;
            }
        }

        // Make API request
        async function runSimulation(formData) {
            const backendUrl = getBackendUrl();
            
            try {
                const response = await fetch(`${backendUrl}/simulate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    if (response.status === 0 || response.status >= 500) {
                        throw new Error('Backend server is not responding. Please try again later.');
                    } else if (response.status === 404) {
                        throw new Error('Backend endpoint not found. Please check the server configuration.');
                    } else {
                        throw new Error(`Server error: ${response.status} ${response.statusText}`);
                    }
                }
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('API request failed:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('Cannot connect to backend server. Please check if the server is running.');
                } else {
                    throw new Error(error.message || 'Failed to connect to the server');
                }
            }
        }

        // Handle form submission
        async function handleSubmit(event) {
            event.preventDefault();
            
            // Get form data
            const formData = {
                symbol: document.getElementById('symbol').value.trim().toUpperCase(),
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                ma1_window: parseInt(document.getElementById('ma1').value),
                ma2_window: parseInt(document.getElementById('ma2').value)
            };
            
            // Validate form
            const validationErrors = validateForm(formData);
            if (validationErrors.length > 0) {
                showError(validationErrors.join('. '));
                return;
            }
            
            // Show loading state
            showLoading();
            
            try {
                // Run simulation
                const result = await runSimulation(formData);
                
                if (result.success) {
                    // Store results and redirect to result page
                    localStorage.setItem('simulationResults', JSON.stringify(result));
                    window.location.href = './result.html';
                } else {
                    throw new Error(result.error || 'Simulation failed');
                }
                
            } catch (error) {
                console.error('Simulation error:', error);
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        // Add input event listeners for real-time validation
        function addInputValidation() {
            const ma1Input = document.getElementById('ma1');
            const ma2Input = document.getElementById('ma2');
            
            function validateMAs() {
                const ma1 = parseInt(ma1Input.value);
                const ma2 = parseInt(ma2Input.value);
                
                if (ma1 && ma2 && ma1 >= ma2) {
                    ma1Input.setCustomValidity('Short MA must be smaller than Long MA');
                    ma2Input.setCustomValidity('Long MA must be larger than Short MA');
                } else {
                    ma1Input.setCustomValidity('');
                    ma2Input.setCustomValidity('');
                }
            }
            
            ma1Input.addEventListener('input', validateMAs);
            ma2Input.addEventListener('input', validateMAs);
            
            // Date validation
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            function validateDates() {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                
                if (startDate && endDate && startDate >= endDate) {
                    startDateInput.setCustomValidity('Start date must be before end date');
                    endDateInput.setCustomValidity('End date must be after start date');
                } else {
                    startDateInput.setCustomValidity('');
                    endDateInput.setCustomValidity('');
                }
            }
            
            startDateInput.addEventListener('change', validateDates);
            endDateInput.addEventListener('change', validateDates);
        }

        // Popular stock symbols for quick selection
        function addStockSuggestions() {
            const symbolInput = document.getElementById('symbol');
            const suggestions = [
                'TCS.NS', 'INFY.NS', 'HDFCBANK.NS', 'ICICIBANK.NS', 'SBIN.NS',
                'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA', 'META'
            ];
            
            // Create datalist for autocomplete
            const datalist = document.createElement('datalist');
            datalist.id = 'stockSuggestions';
            
            suggestions.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                datalist.appendChild(option);
            });
            
            symbolInput.setAttribute('list', 'stockSuggestions');
            symbolInput.parentNode.appendChild(datalist);
        }

        // Keyboard shortcuts
        function addKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                // Ctrl/Cmd + Enter to submit form
                if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                    event.preventDefault();
                    form.dispatchEvent(new Event('submit'));
                }
                
                // Escape to hide error
                if (event.key === 'Escape') {
                    errorAlert.classList.add('hidden');
                }
            });
        }

        // Initialize the application
        async function init() {
            // Set default values
            setDefaults();
            
            // Test backend connection
            console.log('Testing backend connection...');
            const backendUrl = getBackendUrl();
            console.log('Backend URL:', backendUrl);
            
            const connectionOk = await testBackendConnection();
            if (!connectionOk) {
                showError('Warning: Cannot connect to backend server. Please check your connection.');
            }
            
            // Add event listeners
            form.addEventListener('submit', handleSubmit);
            
            // Add input validation
            addInputValidation();
            
            // Add stock suggestions
            addStockSuggestions();
            
            // Add keyboard shortcuts
            addKeyboardShortcuts();
            
            console.log('Trading Strategy Simulator initialized');
        }

        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>